class AdminBot {
    constructor() {
        this.messages = document.getElementById('chat-messages');
        this.input = document.getElementById('chat-input');
        this.sendBtn = document.getElementById('chat-send');
        this.resetBtn = document.getElementById('reset-chat');

        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≥‡∏•‡∏≠‡∏á
        this.products = [
            { id: 1, name: '‡πÄ‡∏î‡∏£‡∏™‡∏•‡∏≤‡∏¢‡∏ï‡∏≤‡∏£‡∏≤‡∏á', price: 350 },
            { id: 2, name: '‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏´‡∏°‡∏û‡∏£‡∏°', price: 420 },
            { id: 3, name: '‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∑‡∏î Oversize', price: 590 }
        ];

        // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡∏¢ (State Machine)
        // steps: 'idle', 'select_size', 'select_qty', 'ask_address', 'confirm'
        this.state = 'idle'; 
        
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
        this.order = {
            product: null,
            size: null,
            qty: 1,
            address: null,
            total: 0
        };

        this.init();
    }

    init() {
        this.sendBtn.addEventListener('click', () => this.handleInput());
        this.input.addEventListener('keypress', (e) => { if(e.key === 'Enter') this.handleInput(); });
        this.resetBtn.addEventListener('click', () => this.resetChat());

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢
        this.botSay('‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ üôè ‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞');
        this.showProductOptions();
    }

    resetChat() {
        this.state = 'idle';
        this.order = { product: null, size: null, qty: 1, address: null, total: 0 };
        this.messages.innerHTML = '';
        this.botSay('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏™‡∏ô‡πÉ‡∏à‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô‡∏î‡∏µ‡∏Ñ‡∏∞?');
        this.showProductOptions();
    }

    handleInput() {
        const text = this.input.value.trim();
        if(!text) return;

        this.userSay(text);
        this.input.value = '';

        // ‡∏î‡∏µ‡πÄ‡∏•‡∏¢‡πå‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå
        setTimeout(() => this.processState(text), 600);
    }

    // --- ‡∏™‡∏°‡∏≠‡∏á‡∏Å‡∏•‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô (The Brain) ---
    processState(text) {
        // ‡∏ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ß‡πà‡∏≤ "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà"
        if (text.includes('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å') || text.includes('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà')) {
            this.resetChat();
            return;
        }

        switch(this.state) {
            case 'idle':
                this.checkProduct(text);
                break;
            case 'select_size':
                this.saveSize(text);
                break;
            case 'select_qty':
                this.saveQty(text);
                break;
            case 'ask_address':
                this.saveAddress(text);
                break;
            case 'confirm':
                this.botSay('‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏≠‡∏∏‡∏î‡∏´‡∏ô‡∏∏‡∏ô‡∏Ñ‡πà‡∏∞! ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ üòä');
                break;
        }
    }

    // 1. ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    checkProduct(text) {
        // ‡∏´‡∏≤‡∏ß‡πà‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡πÑ‡∏´‡∏°
        const found = this.products.find(p => text.includes(p.name) || text.includes(p.id));
        
        if (found) {
            this.order.product = found;
            this.state = 'select_size';
            this.botSay(`‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∏‡πà‡∏ô "${found.name}" ‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏ø${found.price}`);
            this.botSay('‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏™‡πà‡πÑ‡∏ã‡∏™‡πå‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ‡∏Ñ‡∏∞? (XS, S, M, L, XL)');
        } else {
            this.botSay('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ üòÖ ‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞?');
            this.showProductOptions();
        }
    }

    // 2. ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ã‡∏™‡πå
    saveSize(text) {
        const size = text.toUpperCase();
        if (['XS','S','M','L','XL','XXL','FREE SIZE'].some(s => size.includes(s))) {
            this.order.size = size;
            this.state = 'select_qty';
            this.botSay(`‡πÇ‡∏≠‡πÄ‡∏Ñ‡∏Ñ‡πà‡∏∞ ‡πÑ‡∏ã‡∏™‡πå ${size} ‡∏ô‡∏∞‡∏Ñ‡∏∞ üëå`);
            this.botSay('‡∏£‡∏±‡∏ö‡∏Å‡∏µ‡πà‡∏ï‡∏±‡∏ß‡∏î‡∏µ‡∏Ñ‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤?');
        } else {
            this.botSay('‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏ã‡∏™‡πå‡πÄ‡∏õ‡πá‡∏ô S, M, L, XL ‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ô‡πâ‡∏≤');
        }
    }

    // 3. ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
    saveQty(text) {
        // ‡∏î‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÄ‡∏ä‡πà‡∏ô "‡∏£‡∏±‡∏ö 2 ‡∏ï‡∏±‡∏ß‡∏Ñ‡πà‡∏∞" -> 2)
        const qty = parseInt(text.replace(/\D/g, '')) || 1; // ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 1
        
        this.order.qty = qty;
        this.order.total = this.order.product.price * qty;
        
        this.state = 'ask_address';
        this.botSay(`‡∏£‡∏±‡∏ö ${qty} ‡∏ï‡∏±‡∏ß‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° ${this.order.total} ‡∏ö‡∏≤‡∏ó‡∏Ñ‡πà‡∏∞`);
        this.botSay('üìù ‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏Ç‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠-‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà-‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏∞');
    }

    // 4. ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
    saveAddress(text) {
        if (text.length < 10) {
            this.botSay('‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏±‡πâ‡∏ô‡πÑ‡∏õ‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡∏Ñ‡πà‡∏∞ ‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏Ç‡∏≠‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ‡∏ï‡∏≥‡∏ö‡∏• ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠) ‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡∏ô‡∏∞‡∏Ñ‡∏∞ üôè');
            return;
        }

        this.order.address = text;
        this.state = 'confirm';
        
        // ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î
        this.botSay('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞! ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏∞‡∏Ñ‡∏∞ üëá');
        this.showOrderSummary();
        this.botSay('üí≥ ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà:\n‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢\n‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: 123-4-56789-0\n‡∏ä‡∏∑‡πà‡∏≠: SWG Shop\n\n‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞! ‚ú®');
    }

    // --- Helper Functions ---

    botSay(text) {
        const div = document.createElement('div');
        div.className = 'message bot';
        div.innerText = text;
        this.messages.appendChild(div);
        this.scrollToBottom();
    }

    userSay(text) {
        const div = document.createElement('div');
        div.className = 'message user';
        div.innerText = text;
        this.messages.appendChild(div);
        this.scrollToBottom();
    }

    showProductOptions() {
        const div = document.createElement('div');
        div.className = 'options-container';
        this.products.forEach(p => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = p.name;
            btn.onclick = () => {
                this.userSay(p.name);
                this.processState(p.name);
            };
            div.appendChild(btn);
        });
        
        const msgDiv = document.createElement('div');
        msgDiv.className = 'message bot';
        msgDiv.style.background = 'transparent';
        msgDiv.style.padding = '0';
        msgDiv.style.boxShadow = 'none';
        msgDiv.appendChild(div);
        this.messages.appendChild(msgDiv);
        this.scrollToBottom();
    }

    showOrderSummary() {
        const div = document.createElement('div');
        div.className = 'order-summary';
        div.innerHTML = `
            <div class="order-row"><span>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</span> <span>${this.order.product.name}</span></div>
            <div class="order-row"><span>‡πÑ‡∏ã‡∏™‡πå:</span> <span>${this.order.size}</span></div>
            <div class="order-row"><span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</span> <span>${this.order.qty} ‡∏ï‡∏±‡∏ß</span></div>
            <div class="order-row"><span>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</span> <span>${this.order.address}</span></div>
            <div class="order-total"><span>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</span> <span>‡∏ø${this.order.total.toLocaleString()}</span></div>
        `;
        const msgDiv = document.createElement('div');
        msgDiv.className = 'message bot';
        msgDiv.style.background = 'transparent'; 
        msgDiv.style.padding = '0';
        msgDiv.style.boxShadow = 'none';
        msgDiv.appendChild(div);
        this.messages.appendChild(msgDiv);
        this.scrollToBottom();
    }

    scrollToBottom() {
        this.messages.scrollTop = this.messages.scrollHeight;
    }
}

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
document.addEventListener('DOMContentLoaded', () => {
    new AdminBot();
});